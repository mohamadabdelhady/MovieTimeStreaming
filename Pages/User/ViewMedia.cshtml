@page
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@model MovieTimeStreaming.Pages.User.ViewMediaModel
@{var CurrentUser = UserManager.GetUserAsync(User);}
@{
    Layout = "Shared/_Layout_User";
    ViewData["Title"] = "Main";
}
<div class="row mt-4 container">
    <div class="col-4">
        <img alt="Media poster image" class="MediaPosterImg mb-2" src="@Model.MediaImg"/>
        <a href="" class="btn my-btn" style="width: 100%">Bookmark</a>
        <a asp-page="videoPlayer" style="width: 100%" asp-route-id="@Model.MediaId" class="btn my-btn mt-2">Watch</a>
    </div>
    <div class="col-6">
        <h2>@Model.MediaTitle</h2>
        <p>Media Type: @Model.MediaType</p>
        <p>Media Genere: @Model.MediaGenre</p>
        <br/>
        <h5>About </h5>
        <div class="card">
            <p class="p-2">@Model.MediaAbout</p>
        </div>
    </div>
</div>
<div class="row container mt-5">
    <div class="col-12">
        
        <div id="app">
            <div>
                 <div>
                <div v-if="!my_review.length" class="review p-2" >
                        <p class="">What did you think of this @Model.MediaType</p>
                    <span class="mt-2 stars" style="padding-left: 60px;">
                        <a href="#" class='' id="star_1" @@mouseover="fill_star(1)" @@mouseleave="empty_star()" v-on:click.prevent="set_rating(1)"><i class="fa fa-star fa-3x"></i></a>
                        <a href="#" class='' id="star_2" @@mouseover="fill_star(2)" @@mouseleave="empty_star()" v-on:click.prevent="set_rating(2)"><i class="fa fa-star fa-3x"></i></a>
                        <a href="#" class='' id="star_3" @@mouseover="fill_star(3)" @@mouseleave="empty_star()" v-on:click.prevent="set_rating(3)"><i class="fa fa-star fa-3x"></i></a>
                        <a href="#" class='' id="star_4" @@mouseover="fill_star(4)" @@mouseleave="empty_star()" v-on:click.prevent="set_rating(4)"><i class="fa fa-star fa-3x"></i></a>
                        <a href="#" class='' id="star_5" @@mouseover="fill_star(5)" @@mouseleave="empty_star()" v-on:click.prevent="set_rating(5)"><i class="fa fa-star fa-3x"></i></a>
                        <span class="ml-2 rate">{{my_rating}}/5</span>
                        <span v-if="my_rating!=''" class="ml-2 rate"><a href="#" v-on:click.prevent="clear_rating">Clear rating</a></span>
                    </span>
                    <div class="mt-3">
                        <textarea row="10" placeholder=" Write a review (optional)." class="comment_in" v-model="user_review" @@keyup.enter="add_review"></textarea>
                        <button v-if="edit_review==false" class="btn my-btn" style="height: 40px;" :disabled="user_review==''" v-on:click="add_review">Post</button>
                        <div v-else>
                        <button class="btn" style="height: 40px;" :disabled="user_review==''" v-on:click="update_review">Edit</button>
                        <button class="btn ml-2 btn-cancel" style="height: 40px;" :disabled="user_review==''" v-on:click="cancel_edit">Cancel</button>
                            </div>
                        <p id="error_post" style="color: firebrick; display: none;">You have to pick a rating to post a review.</p>
                    </div>
                
                </div>
                    <div v-else class="my_review p-2" v-for="(review,index) in my_review">
                        <span class="txtb">Your review</span>
                        <a href="#"><span class="pl-1">{{review.name}}</span></a>
                        <span style="float: right;"><generate_stars :rating="review.rating"></generate_stars></span>
                        <p class="pt-2 txts" style="padding-left: 60px;">{{review.review}}</p>
                        <div class="dropdown">
                            <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                ...
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <a class="dropdown-item" href="#" onclick="event.preventDefault(); document.getElementById('edit-btn').click();">Edit</a>
                                <button type="button" class="btn btn-info btn-lg" v-on:click="edit_reviewF" style="display: none;" id="edit-btn"></button>
                                <a class="dropdown-item" href="#" v-on:click.prevent="delete_review">Delete</a>
                
                            </div>
                        </div>
                    </div>
                
                    </div>
                <hr>
                <p class=" mt-4">What other Users think of the @Model.MediaType.</p>

                <div class="mt-5">
                    <p v-if="!review_data.length" class="" style="margin-left:50px;">There is no reviews on this @Model.MediaType, be the first one to review it.</p>
                    <div class="comments" v-for="(review,index) in review_data">
                        <div>
                            <img src="" class="userAvatar">
                            <span class="pl-1">{{review.name}}</span>
                            <span style="float: right;"><div>
                                                            <div class="row m-auto">
                                                                <span class="fa fa-star checked" v-if="rating>=1"></span>
                                                                <span class="fa fa-star " v-else></span>
                                                                <span class="fa fa-star checked " v-if="rating>=2"></span>
                                                                <span class="fa fa-star " v-else></span>
                                                                <span class="fa fa-star checked " v-if="rating>=3"></span>
                                                                <span class="fa fa-star " v-else></span>
                                                                <span class="fa fa-star checked -" v-if="rating>=4"></span>
                                                                <span class="fa fa-star " v-else></span>
                                                                <span class="fa fa-star checked " v-if="rating>=5"></span>
                                                                <span class="fa fa-star " v-else></span>
                                                                <span class="ml-2 rate">{{rating}}/5</span>
                                                            </div>
                                                        
                                                        </div></span>
                        </div>
                        <p class="pt-2" style="padding-left: 60px;">{{review.review}}</p>
                        <hr>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<script type="module">
const { createApp } = Vue
      createApp({
        data() {
            return {
                        review_data: [],
                        page: 1,
                        made_review:1,
                        edit_review:false,
                        my_rating: "",
                        user_review: "",
                        my_review: [],
                        rating:0,
                    }
            },
            methods: {
                    get_reviews() {
                        axios.get('load_all_reviews/' + this.id + '/' + this.type + '?page=' + this.page).then(response => {
                            $.each(response.data.data, (key, v) => {
                                this.review_data.push(v);
                            });
                        })
            
                    },
            
                    updateR()
                    {
                        this.made_review++;
            
                    },
                     fill_star(num) {
                                console.log(num);
                                for (let i = 1; i <= num; i++) {
                                   let targetDiv= document.getElementById('star_' + i).style.color = 'goldenrod';
                                    console.log(targetDiv);
                                }
                            },
                            empty_star() {
                    
                                let current_rate = this.my_rating;
                                for (let i = 5; i > current_rate; i--) {
                                    document.getElementById('star_' + i).style.color = '#212529';
                                }
                            },
                            set_rating(num) {
                                this.my_rating = num;
                            },
                            add_review() {
                                if (this.my_rating != '') {
                                    document.getElementById('error_post').style.display = 'none';
                                    axios.post('post_review', {
                                        review: this.user_review,
                                        rating: this.my_rating,
                                        id: this.id,
                                        type: this.type,
                                        user: this.user_id,
                                    })
                                    this.user_review = "";
                                    this.$emit('update_review');
                                } else {
                                    document.getElementById('error_post').style.display = 'block';
                                }
                            },
                            get_my_review() {
                                axios.get('get_my_review/' + this.id + '/' + this.type).then(response => {
                                    if (response.data != "") {
                                        this.my_review.push(response.data);
                    
                                    } else {
                                        this.my_review = [];
                                    }
                                });
                            },
                            clear_rating() {
                                this.my_rating = "";
                                this.empty_star();
                            },
                            edit_reviewF() {
                                this.user_review = this.my_review[0].review;
                                this.my_rating = this.my_review[0].rating;
                                this.my_review = [];
                                this.edit_review = true;
                    
                            },
                            update_review()
                            {
                                if (this.my_rating != '') {
                                    document.getElementById('error_post').style.display = 'none';
                                    axios.post('edit_review', {
                                        review: this.user_review,
                                        rating: this.my_rating,
                                        user: this.user_id,
                                    })
                                    this.user_review = "";
                                    this.$emit('update_review');
                                } else {
                                    document.getElementById('error_post').style.display = 'block';
                                }
                            },
                            delete_review()
                            {
                                axios.get('delete_review/'+this.id+'/'+this.type).then(response => {
                                    this.$emit('update_review');
                                });
                            },
                            cancel_edit()
                            {
                                this.$emit('update_review');
                            }
                },
                mounted() {
                    this.get_reviews();
                    this.get_my_review();
                        
                }, 
  }).mount('#app')
</script>